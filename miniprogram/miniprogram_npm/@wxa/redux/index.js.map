{"version":3,"sources":["index.js","mapState.js","registry.js"],"names":[],"mappings":";;;;;;;AAAA;AACA;AACA;AACA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA,ACHA;AFOA,ACHA,ACHA;AFOA,ACHA,ACHA;AFOA,ACHA,ACHA;AFOA,ACHA,ACHA;AFOA,ACHA,ACHA;AFOA,ACHA,ACHA;AFOA,ACHA,ACHA;AFOA,ACHA,ACHA;AFOA,ACHA,ACHA;AFOA,ACHA,ACHA;AFOA,ACHA,ACHA;AFOA,ACHA,ACHA;AFOA,ACHA,ACHA;AFOA,ACHA,ACHA;AFOA,ACHA,ACHA;AFOA,ACHA,ACHA;AFOA,ACHA,ACHA;AFOA,ACHA,ACHA;AFOA,ACHA,ACHA;AFOA,ACHA,ACHA;AFOA,ACHA,ACHA;AFOA,ACHA,ACHA;AFOA,ACHA,ACHA;AFOA,ACHA,ACHA;AFOA,ACHA,ACHA;AFOA,ACHA,ACHA;AFOA,ACHA,ACHA;AFOA,ACHA,ACHA;AFOA,ACHA,ACHA;AFOA,ACHA,ACHA;AFOA,ACHA,ACHA;AFOA,ACHA,ACHA;AFOA,ACHA,ACHA;AFOA,ACHA,ACHA;AFOA,ACHA,ACHA;AFOA,ACHA,ACHA;AFOA,ACHA,ACHA;AFOA,AENA;AFOA,AENA;AFOA,AENA;AFOA,AENA;AFOA,AENA;AFOA,AENA;AFOA,AENA;AFOA,AENA;AFOA,AENA;AFOA,AENA;AFOA,AENA;AFOA,AENA;AFOA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"index.js","sourcesContent":["\n\nObject.defineProperty(exports, \"__esModule\", {\n    value: true\n});\nexports.reducerRegistry = exports.wxaRedux = undefined;\n\nvar _typeof = typeof Symbol === \"function\" && typeof Symbol.iterator === \"symbol\" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === \"function\" && obj.constructor === Symbol && obj !== Symbol.prototype ? \"symbol\" : typeof obj; };\n\nvar _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; };\n\nexports.getStore = getStore;\n\nvar _redux = require('redux');\n\nObject.keys(_redux).forEach(function (key) {\n    if (key === \"default\" || key === \"__esModule\") return;\n    Object.defineProperty(exports, key, {\n        enumerable: true,\n        get: function get() {\n            return _redux[key];\n        }\n    });\n});\n\nvar _mapState = require('./mapState');\n\nvar _mapState2 = _interopRequireDefault(_mapState);\n\nvar _registry = require('./registry');\n\nvar _registry2 = _interopRequireDefault(_registry);\n\nvar _core = require('@wxa/core');\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\nfunction _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }\n\nvar combine = function combine(registryReducers, userReducers) {\n    // if the user directly pass combined reducers to plugin, then we need to use it directly;\n    if (typeof userReducers === 'function') return userReducers;\n\n    // const reducerNames = Object.keys(reducers);\n    // Object.keys(initialState).forEach(item => {\n    //     if (reducerNames.indexOf(item) === -1) {\n    //         reducers[item] = (state = null) => state;\n    //     }\n    // });\n    return (0, _redux.combineReducers)(_extends({}, registryReducers, userReducers));\n};\n\nvar checkAndFilterDataField = function checkAndFilterDataField(data) {\n    var maxSize = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : 1024 * 1000;\n\n    var check = function check(key, value) {\n        var str = JSON.stringify(value);\n        if (typeof str !== 'string') return true;\n\n        var len = str.length;\n        if (len > maxSize) {\n            console.error(key + ' \\u6570\\u636E\\u957F\\u5EA6\\u4E3A' + len + ', \\u6570\\u636E\\u5927\\u4E8E' + maxSize + '\\u5C06\\u65E0\\u6CD5\\u540C\\u6B65\\u5230webview');\n\n            return false;\n        }\n        return true;\n    };\n\n    var ret = Array.isArray(data) ? [] : {};\n    if ((typeof data === 'undefined' ? 'undefined' : _typeof(data)) === 'object' && data != null) {\n        Object.keys(data).forEach(function (key) {\n            if (check(key, data[key])) {\n                ret[key] = data[key];\n            };\n        });\n    } else {\n        ret = data;\n    }\n    return ret;\n};\n\nvar isEmpty = function isEmpty(val) {\n    return val == null || !Object.keys(val).length;\n};\n\nvar simpleDeepClone = function simpleDeepClone(val) {\n    if (val == null) return val;\n    try {\n        var ret = JSON.parse(JSON.stringify(val));\n        return ret;\n    } catch (e) {\n        console.error('[@wxa/redux] 深拷贝失败 ', e);\n        return Object.assign({}, val);\n    }\n};\n\nvar _store = void 0;\n\nfunction getStore() {\n    if (_store == null) console.warn('%c[@wxa/redux] store is null, initial redux plugin first in app.wxa', 'font-size: 12px; color: red;');\n\n    return _store;\n}\n\nvar wxaRedux = exports.wxaRedux = function wxaRedux() {\n    var options = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n\n    // get options.\n    var args = [];\n    var userReducers = void 0;\n    var debug = false;\n    if (Array.isArray(options)) {\n        userReducers = options[0];\n        // object reducer\n        args = [combine(_registry2.default.getReducers(), userReducers)].concat(_toConsumableArray(options.slice(1)));\n    } else {\n        userReducers = options.reducers;\n        debug = options.debug;\n        var middlewares = options.middlewares,\n            initialState = options.initialState;\n\n\n        args = [combine(_registry2.default.getReducers(), userReducers), initialState];\n        if (Array.isArray(middlewares)) args.push(_redux.applyMiddleware.apply(undefined, _toConsumableArray(middlewares)));else if (typeof middlewares === 'function') args.push(middlewares);\n    }\n\n    // create Store directly;\n    // cause the reducer may be attached at subpackages.\n    var store = _redux.createStore.apply(null, args);\n    _store = store;\n\n    _registry2.default.setChangeListener(function (reducer) {\n        var reducers = combine(reducer, userReducers);\n        if (debug) {\n            console.group('%c[@wxa/redux] Replacing reducers', 'font-size: 12px; color: green;');\n            console.table({\n                'registered reducer': reducer,\n                'init reducer': userReducers\n            });\n            console.groupEnd();\n        }\n        store.replaceReducer(reducers);\n    });\n\n    var syncStore = function syncStore() {\n        this.$$isCurrentPage = true;\n        var data = (0, _mapState2.default)(this.mapState, this.$store.getState(), this.$$storeLastState, this);\n        if (!isEmpty(data)) {\n            // 有效state\n            data = simpleDeepClone(data);\n            this.$$storeLastState = data;\n            var diffData = this.$$reduxDiff(data);\n            var validData = checkAndFilterDataField(diffData);\n            if (debug) console.log('[@wxa/redux] data ready to set ', _extends({}, validData));\n            this.setData(validData);\n        };\n    };\n\n    var mountRedux = function mountRedux(originHook) {\n        return function () {\n            var _this = this;\n\n            for (var _len = arguments.length, args = Array(_len), _key = 0; _key < _len; _key++) {\n                args[_key] = arguments[_key];\n            }\n\n            this.$$reduxDiff = _core.diff.bind(this);\n            if (this.$store) {\n                var connectState = function connectState() {\n                    var newState = _this.$store.getState();\n                    var lastState = _this.$$storeLastState;\n                    var data = (0, _mapState2.default)(_this.mapState, newState, lastState, _this);\n                    if (!isEmpty(data)) {\n                        // 防止引用类型错误修改\n                        data = simpleDeepClone(data);\n                        // 有效state\n                        _this.$$storeLastState = data;\n                        var diffData = _this.$$reduxDiff(data);\n                        var validData = checkAndFilterDataField(diffData);\n                        if (debug) console.log('[@wxa/redux] data ready to set ', _extends({}, validData));\n                        if (validData != null) _this.setData(validData);\n                    }\n                };\n                this.$unsubscribe = this.$store.subscribe(function () {\n                    // Object updated && page is showing\n                    if (_this.$$isCurrentPage) {\n                        connectState();\n                    }\n                });\n                // 直接挂载一次数据，这样子onLoad阶段可以直接使用现有数据\n                connectState();\n            }\n            if (originHook) originHook.apply(this, args);\n        };\n    };\n\n    var unmountRedux = function unmountRedux(originUnmount) {\n        return function () {\n            if (this.$unsubscribe) {\n                this.$unsubscribe();\n                this.$unsubscribe = null;\n                this.$$storeLastState = null;\n            }\n\n            for (var _len2 = arguments.length, args = Array(_len2), _key2 = 0; _key2 < _len2; _key2++) {\n                args[_key2] = arguments[_key2];\n            }\n\n            if (originUnmount) originUnmount.apply(this, args);\n        };\n    };\n\n    return function (vm, type) {\n        switch (type) {\n            case 'App':\n                vm.$store = store;\n                break;\n            case 'Page':\n                vm.$store = store;\n                var onLoad = vm.onLoad,\n                    onShow = vm.onShow,\n                    onUnload = vm.onUnload,\n                    onHide = vm.onHide;\n\n                vm.onLoad = mountRedux(onLoad);\n                vm.onShow = function () {\n                    syncStore.bind(this)();\n\n                    for (var _len3 = arguments.length, args = Array(_len3), _key3 = 0; _key3 < _len3; _key3++) {\n                        args[_key3] = arguments[_key3];\n                    }\n\n                    if (onShow) onShow.apply(this, args);\n                };\n                vm.onHide = function () {\n                    this.$$isCurrentPage = false;\n\n                    for (var _len4 = arguments.length, args = Array(_len4), _key4 = 0; _key4 < _len4; _key4++) {\n                        args[_key4] = arguments[_key4];\n                    }\n\n                    if (onHide) onHide.apply(this, args);\n                };\n                vm.onUnload = unmountRedux(onUnload);\n                break;\n            case 'Component':\n                var created = vm.created,\n                    attached = vm.attached,\n                    detached = vm.detached,\n                    pageLifetimes = vm.pageLifetimes,\n                    lifetimes = vm.lifetimes;\n\n\n                vm.pageLifetimes = pageLifetimes || {};\n                vm.lifetimes = lifetimes || {};\n                var _vm$pageLifetimes = vm.pageLifetimes,\n                    show = _vm$pageLifetimes.show,\n                    hide = _vm$pageLifetimes.hide;\n                var _vm$lifetimes = vm.lifetimes,\n                    lifetimesAttached = _vm$lifetimes.attached,\n                    lifetimesDetached = _vm$lifetimes.detached;\n                // auto sync store data to component.\n\n                vm.pageLifetimes.show = function () {\n                    if (this.$$reduxDiff) syncStore.bind(this)();\n\n                    for (var _len5 = arguments.length, args = Array(_len5), _key5 = 0; _key5 < _len5; _key5++) {\n                        args[_key5] = arguments[_key5];\n                    }\n\n                    if (show) show.apply.apply(show, [this].concat(args));\n                };\n                vm.pageLifetimes.hide = function () {\n                    this.$$isCurrentPage = false;\n\n                    for (var _len6 = arguments.length, args = Array(_len6), _key6 = 0; _key6 < _len6; _key6++) {\n                        args[_key6] = arguments[_key6];\n                    }\n\n                    if (hide) hide.apply.apply(hide, [this].concat(args));\n                };\n\n                vm.created = function () {\n                    this.$store = store;\n                    this.$$reduxDiff = _core.diff.bind(this);\n\n                    for (var _len7 = arguments.length, args = Array(_len7), _key7 = 0; _key7 < _len7; _key7++) {\n                        args[_key7] = arguments[_key7];\n                    }\n\n                    if (created) created.apply(this, args);\n                };\n\n                vm.lifetimes.attached = mountRedux(lifetimesAttached || attached);\n                vm.lifetimes.detached = unmountRedux(lifetimesDetached || detached);\n                vm.attached = mountRedux(lifetimesAttached || attached);\n                vm.detached = unmountRedux(lifetimesDetached || detached);\n                break;\n            default:\n                throw new Error('不合法的wxa组件类型');\n        }\n    };\n};\n\nexports.reducerRegistry = _registry2.default;","\n\nObject.defineProperty(exports, \"__esModule\", {\n    value: true\n});\nexports.default = mapState;\n\nvar _shallowequal = require('shallowequal');\n\nvar _shallowequal2 = _interopRequireDefault(_shallowequal);\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\nfunction mapState(map, state, lastState, context) {\n    if (map == null) return null;\n\n    var newState = Object.keys(map).reduce(function (ret, key) {\n        if (typeof map[key] !== 'function') {\n            console.log('mapState\\u4E2D\\u7684' + key + '\\u5FC5\\u987B\\u4E3A\\u51FD\\u6570');\n            return ret;\n        }\n\n        try {\n            var fn = map[key];\n            if (context) fn = fn.bind(context);\n\n            ret[key] = fn(state);\n        } catch (e) {\n            throw e;\n        }\n\n        return ret;\n    }, {});\n\n    if (lastState != null && (0, _shallowequal2.default)(newState, lastState)) {\n        return null;\n    } else {\n        // 初始状态或者更新状态\n        return newState;\n    }\n}","\n\nObject.defineProperty(exports, \"__esModule\", {\n    value: true\n});\n\nvar _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; };\n\nvar _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if (\"value\" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();\n\nfunction _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }\n\nfunction _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError(\"Cannot call a class as a function\"); } }\n\n// http://nicolasgallagher.com/redux-modules-and-code-splitting/\n// learn from nicolas\n\nvar ReducerRegistry = exports.ReducerRegistry = function () {\n    function ReducerRegistry() {\n        _classCallCheck(this, ReducerRegistry);\n\n        this._emitChange = null;\n        this._reducers = {};\n    }\n\n    _createClass(ReducerRegistry, [{\n        key: \"getReducers\",\n        value: function getReducers() {\n            return _extends({}, this._reducers);\n        }\n    }, {\n        key: \"register\",\n        value: function register(name, reducer) {\n            this._reducers = _extends({}, this._reducers, _defineProperty({}, name, reducer));\n            if (this._emitChange) {\n                this._emitChange(this.getReducers());\n            }\n        }\n    }, {\n        key: \"setChangeListener\",\n        value: function setChangeListener(listener) {\n            this._emitChange = listener;\n        }\n    }]);\n\n    return ReducerRegistry;\n}();\n\nvar reducerRegistry = new ReducerRegistry();\nexports.default = reducerRegistry;"]}